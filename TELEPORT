-- ====== SERVICES ======
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

-- ====== SCREEN GUI ======
local ScreenGui = Instance.new("ScreenGui", CoreGui)
ScreenGui.Name = "CatTeleportGUI"
ScreenGui.ResetOnSpawn = false

-- ====== MAIN FRAME ======
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.fromOffset(320, 420)
MainFrame.Position = UDim2.fromScale(0.65, 0.2)
MainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame)

local Stroke = Instance.new("UIStroke", MainFrame)
Stroke.Thickness = 2
Stroke.Color = Color3.fromRGB(80,80,80)

-- ====== HEADER ======
local HeaderBar = Instance.new("Frame", MainFrame)
HeaderBar.Size = UDim2.new(1,0,0,35)
HeaderBar.BackgroundTransparency = 1

local Title = Instance.new("TextLabel", HeaderBar)
Title.Size = UDim2.new(1,-70,1,0)
Title.BackgroundTransparency = 1
Title.Text = "Cat's Explorer"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.TextXAlignment = Enum.TextXAlignment.Left

local ButtonsFrame = Instance.new("Frame", HeaderBar)
ButtonsFrame.Size = UDim2.fromOffset(70,30)
ButtonsFrame.Position = UDim2.new(1,-70,0.5,-15)
ButtonsFrame.BackgroundTransparency = 1
local BtnLayout = Instance.new("UIListLayout", ButtonsFrame)
BtnLayout.FillDirection = Enum.FillDirection.Horizontal
BtnLayout.HorizontalAlignment = Enum.HorizontalAlignment.Right
BtnLayout.Padding = UDim.new(0,4)

local MinimizeBtn = Instance.new("TextButton", ButtonsFrame)
MinimizeBtn.Size = UDim2.fromOffset(30,30)
MinimizeBtn.Text = "â€“"
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
MinimizeBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", MinimizeBtn)

local CloseBtn = Instance.new("TextButton", ButtonsFrame)
CloseBtn.Size = UDim2.fromOffset(30,30)
CloseBtn.Text = "X"
CloseBtn.BackgroundColor3 = Color3.fromRGB(120,40,40)
CloseBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", CloseBtn)

-- ====== TABS ======
local Tabs = Instance.new("Frame", MainFrame)
Tabs.Position = UDim2.fromOffset(10,40)
Tabs.Size = UDim2.new(1,-20,0,30)
Tabs.BackgroundTransparency = 1

local TeleportTab = Instance.new("TextButton", Tabs)
TeleportTab.Size = UDim2.new(0.33,0,1,0)
TeleportTab.Text = "Teleport"
TeleportTab.BackgroundColor3 = Color3.fromRGB(50,50,50)
TeleportTab.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", TeleportTab)

local FlyTab = TeleportTab:Clone()
FlyTab.Text = "Fly"
FlyTab.Position = UDim2.new(0.33,0,0,0)
FlyTab.Parent = Tabs

local MiscTab = TeleportTab:Clone()
MiscTab.Text = "Misc"
MiscTab.Position = UDim2.new(0.66,0,0,0)
MiscTab.Parent = Tabs

-- ====== CONTENT FRAMES ======
local TeleportFrame = Instance.new("Frame", MainFrame)
TeleportFrame.Position = UDim2.fromOffset(10,80)
TeleportFrame.Size = UDim2.new(1,-20,1,-90)
TeleportFrame.BackgroundTransparency = 1

local FlyFrame = TeleportFrame:Clone()
FlyFrame.Visible = false
FlyFrame.Parent = MainFrame

local MiscFrame = TeleportFrame:Clone()
MiscFrame.Visible = false
MiscFrame.Parent = MainFrame

-- ====== TELEPORT CONTENT ======
local SearchBox = Instance.new("TextBox", TeleportFrame)
SearchBox.Size = UDim2.new(1,0,0,28)
SearchBox.PlaceholderText = "Search player..."
SearchBox.BackgroundColor3 = Color3.fromRGB(40,40,40)
SearchBox.TextColor3 = Color3.fromRGB(255,255,255)
SearchBox.ClearTextOnFocus = false
Instance.new("UICorner", SearchBox)

local SearchStroke = Instance.new("UIStroke", SearchBox)
SearchStroke.Thickness = 1
SearchStroke.Color = Color3.fromRGB(90,90,90)

local Scroll = Instance.new("ScrollingFrame", TeleportFrame)
Scroll.Position = UDim2.fromOffset(0,35)
Scroll.Size = UDim2.new(1,0,1,-120)
Scroll.BackgroundTransparency = 1
Scroll.CanvasSize = UDim2.new()
Scroll.ScrollBarImageTransparency = 0.5
local Layout = Instance.new("UIListLayout", Scroll)

local loopTarget
local looping = false

local LoopBtn = Instance.new("TextButton", TeleportFrame)
LoopBtn.Size = UDim2.new(1,0,0,28)
LoopBtn.Position = UDim2.fromScale(0,1)
LoopBtn.AnchorPoint = Vector2.new(0,1)
LoopBtn.Text = "Loop Goto (Select Player)"
LoopBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
LoopBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", LoopBtn)

local function teleportTo(player)
    local character = LocalPlayer.Character
    local target = player.Character
    if character and target and character:FindFirstChild("Humanoid") and target:FindFirstChild("HumanoidRootPart") then
        pcall(function()
            character:MoveTo(target.HumanoidRootPart.Position + Vector3.new(0,3,0))
        end)
    end
end

RunService.Heartbeat:Connect(function()
    if looping and loopTarget then
        teleportTo(loopTarget)
    end
end)

LoopBtn.MouseButton1Click:Connect(function()
    looping = not looping
    LoopBtn.Text = looping and "Stop Loop" or "Loop Goto (Select Player)"
end)

-- ====== FLY SYSTEM ======
local flying = false
local flyConnection
local flySpeed = 50

local function fly()
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChild("Humanoid")
    if not hrp or not humanoid then return end

    flying = true
    humanoid.PlatformStand = true

    flyConnection = RunService.RenderStepped:Connect(function()
        if flying then
            local cam = workspace.CurrentCamera
            local moveDir = Vector3.new()
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir += cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir -= cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir -= cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir += cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir += Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveDir -= Vector3.new(0,1,0) end
            if moveDir.Magnitude > 0 then
                hrp.Velocity = moveDir.Unit * flySpeed
            else
                hrp.Velocity = Vector3.new(0,0,0)
            end
        end
    end)
end

local function unfly()
    flying = false
    if flyConnection then flyConnection:Disconnect() end
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
    if humanoid then humanoid.PlatformStand = false end
end

local FlyBtn = Instance.new("TextButton", FlyFrame)
FlyBtn.Size = UDim2.new(1,0,0,40)
FlyBtn.Text = "Fly"
FlyBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
FlyBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", FlyBtn)

local UnflyBtn = FlyBtn:Clone()
UnflyBtn.Text = "Unfly"
UnflyBtn.Position = UDim2.fromOffset(0,45)
UnflyBtn.Parent = FlyFrame

FlyBtn.MouseButton1Click:Connect(fly)
UnflyBtn.MouseButton1Click:Connect(unfly)

-- ====== MISC CONTENT ======
local RejoinBtn = Instance.new("TextButton", MiscFrame)
RejoinBtn.Size = UDim2.new(1,0,0,40)
RejoinBtn.Position = UDim2.fromOffset(0,0)
RejoinBtn.Text = "Rejoin Game"
RejoinBtn.BackgroundColor3 = Color3.fromRGB(60,60,60)
RejoinBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", RejoinBtn)
RejoinBtn.MouseButton1Click:Connect(function()
    TeleportService:Teleport(game.PlaceId, LocalPlayer)
end)

local RefreshBtn = RejoinBtn:Clone()
RefreshBtn.Text = "Refresh Character"
RefreshBtn.Position = UDim2.fromOffset(0,50)
RefreshBtn.Parent = MiscFrame
RefreshBtn.MouseButton1Click:Connect(function()
    if LocalPlayer.Character then
        LocalPlayer.Character:BreakJoints()
    end
end)

-- ====== TAB SWITCH ======
TeleportTab.MouseButton1Click:Connect(function()
    TeleportFrame.Visible = true
    FlyFrame.Visible = false
    MiscFrame.Visible = false
end)
FlyTab.MouseButton1Click:Connect(function()
    TeleportFrame.Visible = false
    FlyFrame.Visible = true
    MiscFrame.Visible = false
end)
MiscTab.MouseButton1Click:Connect(function()
    TeleportFrame.Visible = false
    FlyFrame.Visible = false
    MiscFrame.Visible = true
end)

-- ====== PLAYER LIST REFRESH ======
local function refreshPlayerList()
    for _,v in ipairs(Scroll:GetChildren()) do
        if v:IsA("TextButton") then v:Destroy() end
    end
    local query = SearchBox.Text:lower()
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and (query=="" or string.find(p.Name:lower(), query,1,true)) then
            local b = Instance.new("TextButton", Scroll)
            b.Size = UDim2.new(1,0,0,28)
            b.Text = p.Name
            b.BackgroundColor3 = Color3.fromRGB(50,50,50)
            b.TextColor3 = Color3.fromRGB(255,255,255)
            Instance.new("UICorner", b)
            b.MouseButton1Click:Connect(function()
                teleportTo(p)
                loopTarget = p
            end)
        end
    end
    Scroll.CanvasSize = UDim2.fromOffset(0, Layout.AbsoluteContentSize.Y)
end

SearchBox:GetPropertyChangedSignal("Text"):Connect(refreshPlayerList)
Players.PlayerAdded:Connect(refreshPlayerList)
Players.PlayerRemoving:Connect(refreshPlayerList)
refreshPlayerList()

-- ====== NOTIFICATION & SOUNDS ======
local Notification = Instance.new("Frame", ScreenGui)
Notification.Size = UDim2.fromOffset(260,70)
Notification.Position = UDim2.fromScale(0.2,0.85)
Notification.BackgroundColor3 = Color3.fromRGB(25,25,25)
Notification.BorderSizePixel = 0
Notification.Visible = false
Instance.new("UICorner", Notification)

local NotifText = Instance.new("TextLabel", Notification)
NotifText.Size = UDim2.new(1,-40,1,-10)
NotifText.Position = UDim2.fromOffset(10,5)
NotifText.BackgroundTransparency = 1
NotifText.TextWrapped = true
NotifText.TextScaled = true
NotifText.TextColor3 = Color3.fromRGB(230,230,230)
NotifText.Text = "UI hidden\nPress Right Shift to reopen"

local NotifClose = Instance.new("TextButton", Notification)
NotifClose.Size = UDim2.fromOffset(24,24)
NotifClose.Position = UDim2.fromOffset(230,5)
NotifClose.Text = "X"
NotifClose.BackgroundColor3 = Color3.fromRGB(100,40,40)
NotifClose.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", NotifClose)

local TypingSound = Instance.new("Sound", ScreenGui)
TypingSound.SoundId = "rbxassetid://133003979061644"
TypingSound.Volume = 0.6

local MinimizeSound = Instance.new("Sound", ScreenGui)
MinimizeSound.SoundId = "rbxassetid://131639624315532"
MinimizeSound.Volume = 0.8

local tweenIn = TweenInfo.new(0.35, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
local tweenOut = TweenInfo.new(0.35, Enum.EasingStyle.Quart, Enum.EasingDirection.In)

local uiVisible = true
local savedPos = MainFrame.Position

local function hideUI()
    if not uiVisible then return end
    uiVisible = false
    MinimizeSound:Play()
    TweenService:Create(MainFrame, tweenOut, {Position=UDim2.new(-1,0,MainFrame.Position.Y.Scale,0)}):Play()
    task.delay(0.35, function()
        MainFrame.Visible = false
        Notification.Visible = true
        TweenService:Create(Notification, tweenIn, {Position=UDim2.new(0.7,0,0.8,0)}):Play()
    end)
end

local function showUI()
    if uiVisible then return end
    Notification.Visible = false
    MainFrame.Visible = true
    MainFrame.Position = UDim2.new(-1,0,savedPos.Y.Scale,0)
    TweenService:Create(MainFrame, tweenIn, {Position=savedPos}):Play()
    uiVisible = true
end

MinimizeBtn.MouseButton1Click:Connect(function()
    if uiVisible then hideUI() else showUI() end
end)
CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)
NotifClose.MouseButton1Click:Connect(function() Notification.Visible=false end)

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.RightShift then
        if uiVisible then hideUI() else showUI() end
    end
end)

-- ====== CHAT COMMANDS ======
LocalPlayer.Chatted:Connect(function(msg)
    msg = msg:lower()
    if msg == "!fly" then fly() end
    if msg == "!unfly" then unfly() end
    if msg == "!unloop" then looping = false end
    if msg:sub(1,10) == "!loopgoto " then
        local targetName = msg:sub(11)
        for _,p in ipairs(Players:GetPlayers()) do
            if p.Name:lower():find(targetName:lower()) then
                loopTarget = p
                looping = true
            end
        end
    end
    if msg:sub(1,6) == "!goto " then
        local targetName = msg:sub(7)
        for _,p in ipairs(Players:GetPlayers()) do
            if p.Name:lower():find(targetName:lower()) then
                teleportTo(p)
            end
        end
    end
    if msg == "!rejoin" then
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end
    if msg == "!refresh" then
        if LocalPlayer.Character then LocalPlayer.Character:BreakJoints() end
    end
end)
